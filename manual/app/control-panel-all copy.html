<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Control Panel — UI, Hub & Rebooters (All-in-One)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #0f1115; color: #eaeef2; margin: 0; padding: 20px;
    }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .hint { color: #9aa4af; font-size: 0.9rem; margin: 0 0 16px; }
    table {
      border-collapse: collapse; width: 100%; max-width: 1024px;
      background: #151923; border: 1px solid #232a36; border-radius: 10px; overflow: hidden;
    }
    th, td { padding: 12px 14px; border-bottom: 1px solid #232a36; text-align: left; }
    th { background: #1b2130; font-weight: 600; font-size: 0.95rem; }
    tr:last-child td { border-bottom: none; }
    .section { background:#121621; font-weight:700; color:#9fb4ff; }
    .pill { padding: 2px 8px; border-radius: 999px; font-weight: 700; font-size: 0.85rem; display: inline-block; }
    .up     { color: #0c3322; background: #39f0a3; }
    .down   { color: #3f1111; background: #ff6b6b; }
    .warn   { color: #33280c; background: #ffd166; }
    .ms     { font-variant-numeric: tabular-nums; color: #c7d0da; }
    .ts     { color: #9aa4af; font-size: 0.85rem; }
    .url    { color: #9fb4ff; font-size: 0.85rem; word-break: break-all; }
    @media (max-width: 680px) { .hide-sm { display: none; } }
  </style>
</head>
<body>
  <h1>System Control Panel — All Services</h1>
  <p class="hint">Polling every second. “Alive” = HTTP reachable; “Healthy” = boolean from JSON response if provided.</p>

  <table id="status-table">
    <thead>
    <tr>
      <th>Service</th>
      <th>Alive</th>
      <th>Healthy</th>
      <th class="hide-sm">Latency</th>
      <th class="hide-sm">Endpoint</th>
      <th>Last&nbsp;Change</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // Order with section headers (rendered as fake rows).
    const ROWS = [
      { header: "UI Side" },
      { name: "app_ui" },
      { name: "ui_rebooter1" },
      { name: "ui_rebooter2" },
      { header: "Hub Side" },
      { name: "app_hub" },
      { name: "hub_rebooter1" },
      { name: "hub_rebooter2" },
    ];

    function pill(ok, unknown=false) {
      if (unknown) return `<span class="pill warn">unknown</span>`;
      return ok ? `<span class="pill up">UP</span>` : `<span class="pill down">DOWN</span>`;
    }

    function sectionRow(label) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="section" colspan="6">${label}</td>`;
      return tr;
    }

    async function refresh() {
      try {
        const res = await fetch('/api/status', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const tbody = document.querySelector('#status-table tbody');
        tbody.innerHTML = '';

        for (const item of ROWS) {
          if (item.header) {
            tbody.appendChild(sectionRow(item.header));
            continue;
          }
          const name = item.name;
          const info = data[name];
          if (!info) continue;

          const alive = !!info.alive;
          const hasHealthy = (typeof info.healthy === 'boolean');
          const healthy = hasHealthy ? info.healthy : null;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${name}</td>
            <td>${pill(alive)}</td>
            <td>${pill(healthy, !hasHealthy)}</td>
            <td class="hide-sm ms">${(info.ms != null) ? `${Math.round(info.ms)} ms` : '—'}</td>
            <td class="hide-sm url">${(info.last_url || info.url || '')}</td>
            <td class="ts">${info.last_change || ''}</td>
          `;
          tbody.appendChild(row);
        }
      } catch (e) {
        console.error('Fetch /api/status failed:', e);
      }
    }

    setInterval(refresh, 1000);
    refresh();
  </script>
</body>
</html>
