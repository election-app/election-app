<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Control Panel — Hub & Manual</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #0f1115; color: #eaeef2; margin: 0; padding: 20px;
    }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .hint { color: #9aa4af; font-size: 0.9rem; margin: 0 0 16px; }
    .tabs {
      display: flex; gap: 8px; margin: 12px 0 16px 0; flex-wrap: wrap;
    }
    .tab-btn {
      border: 1px solid #232a36; background: #171b26; color: #cfd6e4;
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
      font-weight: 600; font-size: 0.95rem;
    }
    .tab-btn:hover { background: #1a1f2d; }
    .tab-btn.active { background: #1b2130; color: #9fb4ff; border-color: #334059; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    table {
      border-collapse: collapse; width: 100%; max-width: 1024px;
      background: #151923; border: 1px solid #232a36; border-radius: 10px; overflow: hidden;
    }
    th, td { padding: 12px 14px; border-bottom: 1px solid #232a36; text-align: left; }
    th { background: #1b2130; font-weight: 600; font-size: 0.95rem; }
    tr:last-child td { border-bottom: none; }
    .section { background:#121621; font-weight:700; color:#9fb4ff; }
    .pill { padding: 2px 8px; border-radius: 999px; font-weight: 700; font-size: 0.85rem; display: inline-block; }
    .up   { color: #0c3322; background: #39f0a3; }
    .down { color: #3f1111; background: #ff6b6b; }
    .warn { color: #33280c; background: #ffd166; }
    .ms   { font-variant-numeric: tabular-nums; color: #c7d0da; white-space: nowrap; }
    .ts   { color: #9aa4af; font-size: 0.85rem; white-space: nowrap; }
    .url  { color: #9fb4ff; font-size: 0.85rem; word-break: break-all; }
    @media (max-width: 680px) { .hide-sm { display: none; } }
  </style>
</head>
<body>
  <h1>System Control Panel</h1>
  <p class="hint">
    Polling every second. “Alive” = HTTP reachable (or <code>{"healthy": true}</code> if provided). “Healthy” shows the JSON field when available.
  </p>

  <div class="tabs" role="tablist" aria-label="Control Panel Tabs">
    <button class="tab-btn active" data-tab="hub"   aria-selected="true"  role="tab" aria-controls="pane-hub"   id="tab-hub">AWS Server</button>
  </div>

  <!-- Hub tab -->
  <section id="pane-hub" class="tab-pane active" role="tabpanel" aria-labelledby="tab-hub">
    <table>
      <thead>
      <tr>
        <th>Service</th>
        <th>Alive</th>
        <th>Healthy</th>
        <th class="hide-sm">Latency</th>
        <th class="hide-sm">Endpoint</th>
        <th>Last&nbsp;Change</th>
      </tr>
      </thead>
      <tbody id="tbody-hub"></tbody>
    </table>
  </section>

  <!-- Manual tab -->
  <section id="pane-manual" class="tab-pane" role="tabpanel" aria-labelledby="tab-manual">
    <table>
      <thead>
      <tr>
        <th>Service</th>
        <th>Alive</th>
        <th>Healthy</th>
        <th class="hide-sm">Latency</th>
        <th class="hide-sm">Endpoint</th>
        <th>Last&nbsp;Change</th>
      </tr>
      </thead>
      <tbody id="tbody-manual"></tbody>
    </table>
  </section>

  <script>
    // --- Row definitions per tab ---
    const ROWS = {
      hub: [
        { header: "AWS Server" },
        { name: "live_data_app" },        // default 9052 (via server)
        { name: "manual_data_app" },
      ],
    };

    // --- Small UI helpers ---
    function pill(ok, unknown=false) {
      if (unknown) return `<span class="pill warn">unknown</span>`;
      return ok ? `<span class="pill up">UP</span>` : `<span class="pill down">DOWN</span>`;
    }

    function sectionRow(label) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="section" colspan="6">${label}</td>`;
      return tr;
    }

    function renderGroup(groupName, data, tbodyEl) {
      const list = ROWS[groupName] || [];
      tbodyEl.innerHTML = '';
      for (const item of list) {
        if (item.header) {
          tbodyEl.appendChild(sectionRow(item.header));
          continue;
        }
        const info = data[item.name];
        if (!info) continue;

        const alive = !!info.alive;
        const hasHealthy = (typeof info.healthy === 'boolean');
        const healthy = hasHealthy ? info.healthy : null;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${pill(alive)}</td>
          <td>${pill(healthy, !hasHealthy)}</td>
          <td class="hide-sm ms">${(info.ms != null) ? `${Math.round(info.ms)} ms` : '—'}</td>
          <td class="hide-sm url">${(info.last_url || info.url || '')}</td>
          <td class="ts">${info.last_change || ''}</td>
        `;
        tbodyEl.appendChild(tr);
      }
    }

    async function refresh() {
      try {
        const res = await fetch('/api/status', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderGroup('hub', data,   document.getElementById('tbody-hub'));
        renderGroup('manual', data, document.getElementById('tbody-manual'));
      } catch (e) {
        console.error('Fetch /api/status failed:', e);
      }
    }

    // --- Tabs behavior ---
    function activateTab(name) {
      for (const btn of document.querySelectorAll('.tab-btn')) {
        const on = btn.dataset.tab === name;
        btn.classList.toggle('active', on);
        btn.setAttribute('aria-selected', on ? 'true' : 'false');
      }
      for (const pane of document.querySelectorAll('.tab-pane')) {
        const on = pane.id === `pane-${name}`;
        pane.classList.toggle('active', on);
      }
    }
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn) return;
      activateTab(btn.dataset.tab);
    });

    // initial paint + polling
    activateTab('hub');
    refresh();
    setInterval(refresh, 1000);
  </script>
</body>
</html>
