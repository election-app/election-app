<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Counties (Hub Cache Viewer)</title>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://d3js.org/topojson.v3.min.js"></script>
<style>
  :root { --bg:#0b1220; --fg:#eaf0ff; --muted:#9fb3d1; --card:#14233d; --ok:#a5f3a5; --warn:#ffd79a; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.12);background:#0e1730;font-weight:700;display:flex;align-items:center;gap:10px}
  .wrap{display:grid;grid-template-columns:1fr 420px;gap:14px;height:calc(100% - 48px)}
  svg{width:100%;height:100%;background:#10151f}
  .panel{background:var(--card);border:1px solid rgba(255,255,255,.14);border-radius:14px;display:flex;flex-direction:column;min-height:0}
  .panel h2{margin:0;padding:10px 12px;font-size:14px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,.08)}
  .controls{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:#1f2d50;color:var(--fg);border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:6px 10px;cursor:pointer}
  button:hover{background:#213360}
  .badge{background:#17274a;padding:2px 8px;border-radius:999px;font-size:11px}
  .body{padding:10px;overflow:auto}
  .logline{font-family:ui-monospace,monospace;font-size:12px;white-space:pre-wrap}
  .cand{font-family:ui-monospace,monospace;font-size:13px;margin:2px 0}
  .highlight{stroke:#fff;stroke-width:1.2px}
  .kv{font:12px ui-monospace,monospace}
</style>
</head>
<body>
  <header>
    <div>Hub Cache Viewer — Presidential Counties</div>
    <span id="status" class="badge">loading…</span>
    <span id="paintProgress" class="badge">paint 0/0</span>

    <!-- Single manual action: read cache -->
    <button id="getDataBtn" title="Read cached data from the app (no upstream hit)">Get Data</button>
    <a id="healthLink" class="badge" target="_blank" href="/health">health</a>
  </header>

  <div class="wrap">
    <svg id="map"></svg>
    <aside class="panel">
      <h2>Details & Log</h2>
      <div class="controls">
        <div class="kv">Upstream calls: <span id="calls">…</span></div>
        <div class="kv">Errors: <span id="errs">…</span></div>
      </div>
      <div class="body">
        <h3>Click a county</h3>
        <div id="countyInfo"></div>
        <hr/>
        <div id="logBody"></div>
      </div>
    </aside>
  </div>

<script>
const svg = d3.select("#map");
const statusEl = document.getElementById("status");
const callsEl = document.getElementById("calls");
const errsEl  = document.getElementById("errs");
const logBody = document.getElementById("logBody");
const countyInfo = document.getElementById("countyInfo");
let projection, path, countyShapes, countyData = {}, lastLogSeq = 0;
const paintEl = document.getElementById("paintProgress");
let painting = false, restartAfterPaint = false;
let countiesSel = null;


// TopoJSON from CDN (static)
Promise.all([
  d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
  d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json")
]).then(([stTopo, ctTopo])=>{
  const w = document.querySelector(".wrap").clientWidth - 440;
  const h = document.querySelector(".wrap").clientHeight;
  projection = d3.geoAlbersUsa().translate([w/2, h/2]).scale(Math.min(w,h)*1.25);
  path = d3.geoPath().projection(projection);

  countyShapes = topojson.feature(ctTopo, ctTopo.objects.counties).features;

  svg.selectAll("path.county")
    .data(countyShapes)
    .enter().append("path")
      .attr("class","county")
      .attr("d",path)
      .attr("fill","#222")
      .attr("stroke","#444").attr("stroke-width",0.25)
      .on("click",showCounty);
      countiesSel = svg.selectAll("path.county");


  // initial one-time read from cache
  getDataFromCache();
  setInterval(getDataFromCache, 30_000); // auto-refresh cache read every 30s
});

async function getJSON(url){
  try {
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) return null;
    return await r.json();
  } catch { return null; }
}

// Single action: read cache (no upstream hit)
async function getDataFromCache(){
  const h = await getJSON("/health");
  if(h){
    statusEl.textContent = `hub=${h.hub_mode?'on':'off'} • states=${h.states_cached} • counties=${h.counties_total}`;
    if(h.stats){ callsEl.textContent=h.stats.upstream_calls; errsEl.textContent=h.stats.errors; }
  }

  const d = await getJSON("/cache/p");
  if (d && d.rows) {
    d.rows.forEach(row => { countyData[row.fips] = row; });
    colorizeIncremental();   // <— incremental repaint + HUD progress
  }

  if(selectedFips){
    renderCountyPanel(selectedFips); // refresh the panel with new numbers
  }


  // append-only log read (also cached)
  const lg = await getJSON(`/log?since=${lastLogSeq}`);
  if(lg && lg.items){
    lg.items.forEach(it=>{
      const div=document.createElement("div");
      div.className="logline";
      div.textContent=`[${String(it.seq).padStart(4,"0")}] ${it.ts} ${it.lvl} — ${it.msg}`;
      logBody.appendChild(div);
    });
    lastLogSeq = lg.max_seq || lastLogSeq;
    logBody.scrollTop = logBody.scrollHeight;
  }
}
    
    // --- add here ---
    let selectedFips = null; // track selected county

    function showCounty(event,d){
      svg.selectAll("path.county").classed("highlight",false);
      d3.select(this).classed("highlight",true);
      const f = String(d.id).padStart(5,"0");
      selectedFips = f;  // remember last selected FIPS
      renderCountyPanel(f);
    }

    function renderCountyPanel(f){
      const r = countyData[f];
      if(!r){
        countyInfo.innerHTML = `<p>No cached data for FIPS ${f}</p>`;
        return;
      }
      const lines = r.candidates
        .map(c=>`<div class="cand">${c.name} (${c.party}) — ${fmt(c.votes)}</div>`)
        .join("");
      countyInfo.innerHTML = `<h4>${r.state} — ${r.name}</h4>${lines}<div>Total: ${fmt(r.total)}</div>`;
    }

    function fillForFeature(d){
      const f = String(d.id).padStart(5,"0");
      const r = countyData[f];
      if(!r || !r.candidates || !r.candidates.length) return "#303543"; // no data yet
      const lead = r.candidates.slice().sort((a,b)=>b.votes-a.votes)[0].party;
      if(lead === "REP") return "#c0392b";
      if(lead === "DEM") return "#2980b9";
      return "#8e44ad";
    }

    function colorizeIncremental(){
      if (painting) {          // if a repaint is mid-flight, queue one after
        restartAfterPaint = true;
        return;
      }
      painting = true;
      restartAfterPaint = false;

      const total = countyShapes.length;
      let i = 0, painted = 0;
      const BATCH = 250;       // tune this up/down for speed vs. smoothness

      // reset so the HUD visibly climbs each refresh
      paintEl.textContent = `paint 0/${total}`;
      countiesSel.attr("fill", "#222");

      function step(){
        const end = Math.min(i + BATCH, total);
        countiesSel
          .filter((d, idx) => idx >= i && idx < end)
          .attr("fill", d => {
            const fill = fillForFeature(d);
            if (fill !== "#303543") painted++; // count only counties with data
            return fill;
          });

        paintEl.textContent = `paint ${painted}/${total}`;
        i = end;

        if (i < total) {
          requestAnimationFrame(step);
        } else {
          painting = false;
          if (restartAfterPaint) colorizeIncremental();
        }
      }

      requestAnimationFrame(step);
    }



function fmt(n){return(n||0).toLocaleString("en-US");}


// Wire the single button
document.getElementById("getDataBtn").onclick = getDataFromCache;

// NOTE: there is no setInterval or auto-polling here.
// The only network activity is when you click "Get Data" (reading the cache),
// which does not cause any upstream requests.
</script>
</body>
</html>
