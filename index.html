<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presidential Race — County Map</title>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://d3js.org/topojson.v3.min.js"></script>
<style>
  body { margin:0; font-family:sans-serif; background:#0b1220; color:#eaf0ff }
  header { padding:12px; background:#0e1730; font-weight:bold }
  .wrap { display:grid; grid-template-columns: 1fr 350px; height:calc(100vh - 48px); }
  svg { width:100%; height:100%; background:#111 }
  .sidebar { background:#14233d; padding:12px; overflow:auto }
  .county { stroke:#444; stroke-width:0.25px; cursor:pointer }
  .cand { font-family: ui-monospace, monospace; font-size:13px; margin:2px 0 }
  .highlight { stroke:#fff; stroke-width:1.2px }
</style>
</head>
<body>
  <header>Presidential Race — Counties (Hub Cache)</header>
  <div class="wrap">
    <svg id="map"></svg>
    <div class="sidebar" id="sidebar">
      <h3>Click a county</h3>
      <div id="countyInfo"></div>
    </div>
  </div>

<script>
const svg = d3.select("#map");
const countyInfo = document.getElementById("countyInfo");

let countyShapes, projection, path;
let countyData = {}; // keyed by FIPS

// Load topojson for states + counties
Promise.all([
  d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
  d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json")
]).then(([stTopo, ctTopo])=>{
  projection = d3.geoAlbersUsa().scale(1280).translate([480, 300]);
  path = d3.geoPath().projection(projection);

  countyShapes = topojson.feature(ctTopo, ctTopo.objects.counties).features;

  svg.selectAll("path.county")
    .data(countyShapes)
    .enter().append("path")
      .attr("class","county")
      .attr("d", path)
      .attr("fill", "#222")
      .on("click", showCounty);

  // after drawing map, fetch election data
  fetchData();
});

// fetch from backend cache
async function fetchData(){
  const res = await fetch("/cache/p", {cache:"no-store"});
  const data = await res.json();
  if (data && data.rows){
    data.rows.forEach(r=>{
      countyData[r.fips] = r;
    });
    // colorize map based on lead
    svg.selectAll("path.county")
      .attr("fill", d=>{
        const f = String(d.id).padStart(5,"0");
        const r = countyData[f];
        if (!r) return "#333";
        // find leader
        const sorted = [...r.candidates].sort((a,b)=>b.votes-a.votes);
        if (!sorted.length) return "#333";
        const leader = sorted[0];
        if (leader.party==="REP") return "#c0392b";
        if (leader.party==="DEM") return "#2980b9";
        return "#8e44ad";
      });
  }
}

function fmt(n){ return (n||0).toLocaleString("en-US"); }

function showCounty(event,d){
  svg.selectAll("path.county").classed("highlight",false);
  d3.select(this).classed("highlight",true);

  const f = String(d.id).padStart(5,"0");
  const r = countyData[f];
  if (!r){
    countyInfo.innerHTML = `<p>No data for FIPS ${f}</p>`;
    return;
  }
  const lines = r.candidates.map(c=>
    `<div class="cand">${c.name} (${c.party}) — ${fmt(c.votes)}</div>`
  ).join("");
  countyInfo.innerHTML = `
    <h4>${r.state} — ${r.name}</h4>
    ${lines}
    <div>Total: ${fmt(r.total)}</div>
  `;
}

// poll every 15s to refresh colors
setInterval(fetchData, 15000);
</script>
</body>
</html>
